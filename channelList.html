<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Channels</title>
  <!-- Latest compiled and minified CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">
  <link rel="stylesheet" href="//code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
</head>
<style>
  body {
    height: 100vh;
  }

  .scroll-area::-webkit-scrollbar {
    display: none;
  }

  .container {
    height: 100vh;
  }
</style>
</head>

<body>
  <div class="container-fluid vh-100">
    <div class="row vh-100 channel-list">
      <!-- Channel List Navigation -->
      <div class="d-flex flex-column flex-shrink-0 p-3 text-white bg-dark" style="width:25vw; height:100vh">
        <a href="/" class="d-flex align-items-center mb-3 mb-md-0 me-md-auto text-white text-decoration-none">
          <span class="fs-4">참가중인 채널</span>
        </a>
        <hr>
        <ul class="nav nav-pills flex-column mb-auto channel-list-ul">
          <li class="nav-item">
            <a href="#" class="nav-link text-break" aria-current="page">
              Channel Name
            </a>
          </li>
        </ul>
        <hr>
        <div class="dropdown">
          <a href="#" class="d-flex align-items-center text-white text-decoration-none dropdown-toggle"
            id="dropdownUser1" data-bs-toggle="dropdown" aria-expanded="false">
            <img src="https://github.com/mdo.png" alt="" width="32" height="32" class="rounded-circle me-2">
            <strong id="username">unknown</strong>
          </a>
          <ul class="dropdown-menu dropdown-menu-dark text-small shadow" aria-labelledby="dropdownUser1">
            <li><a class="dropdown-item" id="create-channel-button" data-bs-toggle="modal"
                data-bs-target="#createChannelModal">Create Channel</a></li>
            <li><a class="dropdown-item" id="search-channel" data-bs-toggle="modal"
                data-bs-target="#channelListModal">Search Channels</a></li>
            <li>
              <hr class="dropdown-divider">
            </li>
            <li><a class="dropdown-item" id="logout-button">Sign out</a></li>
          </ul>
        </div>
      </div>
      <!-- Channel List Navigation -->

      <!-- Message Layout -->
      <div class="d-flex flex-column flex-shrink-0 p-3 text-white bg-secondary bg-gradient"
        style="width:73vw; height:100vh max-height=calc(100vh)">
        <div class="row vh-5 channel-name text-self-end">
          <div class="col-6 text-left text-break channel-info-name">
            <input type="hidden" id="channel-id" value="" />
            <input type="hidden" id="offset" value="0" />
            <h4>채널을 선택해주세요</h4>
          </div>
          <div class="col-2 text-left channel-info-name">
            <div class="row">
              <button class="col btn btn-sm btn-outline-warning" style="display:none" data-bs-toggle="modal"
                data-bs-target="#editChannelModal">수정</button>
              <button class="col btn btn-sm btn-outline-danger" id="delete-channel" style="display:none">삭제</button>
            </div>
          </div>
          <div class="col-2">
            <div class="dropdown">
              <a href="#" class="d-flex align-items-center text-white text-decoration-none dropdown-toggle"
                id="dropdownUser1" data-bs-toggle="dropdown" aria-expanded="false">
                <strong id="username">참여중인 멤버</strong>
              </a>
              <!-- Dropdown Member List -->
              <ul class="dropdown-menu dropdown-menu-dark text-small shadow dropdown-member-list"
                aria-labelledby="dropdownUser1">
              </ul>
              <!-- Dropdown Member List -->
            </div>
          </div>
          <div class="col-1 align-items-center align-items-end float-end">
            <a href="#" class="text-white float-end" id="search-messages" data-bs-toggle="modal"
            data-bs-target="#searchMessageModal">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-search" viewBox="0 0 16 16">
                <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/>
              </svg>
            </a>
          </div>
        </div>
        <!--Message Area-->
        <div class="row vh-90" style="max-height:calc(85.8vh)">
          <!-- 메시지 리스트 -->
          <div class="row vh-90 message-list scroll-area overflow-scroll" id="message-list" style="height:calc(80vh);max-height:calc(80vh)">
            &nbsp;
          </div>
          <!-- 메시지 리스트 -->
        </div>
        <!--화면 크기 고정하고 스크롤 가능하게 변경 필요-->
        <!--Message Area-->
        <!-- Chat input area -->
        <div class="input-group mb-3 vh-5">
          <input type="text" class="form-control" id="chat-input" placeholder="" aria-label="Recipient's username"
            aria-describedby="button-addon2" maxlength="100" disabled>
          <button class="btn btn-outline-secondary bg-warning chat-submit" type="button" id="chat-button">전송</button>
        </div>
        <!-- Chat input area -->
      </div>
      <!-- Message Layout -->
    </div>

    <!-- Channel List Modal -->
    <div class="modal fade" id="channelListModal" tabindex="-1" aria-labelledby="channelListModalLabel"
      aria-hidden="true">
      <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header bg-dark text-white">
            <h5 class="modal-title" id="channelListModalLabel">Channel List</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <!-- Not Joined Channel List -->
          <div class="modal-body bg-secondary text-white">
            <ul class="joinable-channel-list">
              <div>참가 가능한 채널 1</div>
            </ul>
          </div>
          <!-- Not Joined Channel List -->
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary modal-close-button" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>
    <!-- Channel List Modal -->

    <!-- Channel Create Modal -->
    <div class="modal fade" id="createChannelModal" data-bs-backdrop="static" tabindex="-1"
      aria-labelledby="createChannelModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header bg-dark text-white">
            <h5 class="modal-title" id="createChannelModalLabel">Create Channel</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <label for="new-channel-name" class="form-label">New Channel Name</label>
            <div class="input-group mb-3">
              <span class="input-group-text" id="basic-addon3">Name</span>
              <input type="text" class="form-control modal-input" id="new-channel-name" aria-describedby="basic-addon3"
                maxlength="50">
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary modal-close-button" data-bs-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary" id="create-channel-button">Create Channel</button>
          </div>
        </div>
      </div>
    </div>
    <!-- Channel Create Modal -->

    <!-- Channel Edit Modal -->
    <div class="modal fade" id="editChannelModal" data-bs-backdrop="static" tabindex="-1"
      aria-labelledby="editChannelModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header bg-dark text-white">
            <h5 class="modal-title" id="editChannelModalLabel">Edit Channel</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <label for="new-channel-name" class="form-label">Edit Channel Name</label>
            <div class="input-group mb-3">
              <span class="input-group-text" id="basic-addon3">Name</span>
              <input type="text" class="form-control modal-input" id="edit-channel-name" aria-describedby="basic-addon3"
                maxlength="50">
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary modal-close-button" data-bs-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary" id="edit-channel-button">Edit Channel</button>
          </div>
        </div>
      </div>
    </div>
    <!-- Channel Edit Modal -->

    <!-- Message Edit Modal -->
    <div class="modal fade" id="editMessageModal" data-bs-backdrop="static" tabindex="-1"
      aria-labelledby="editMessageModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header bg-dark text-white">
            <h5 class="modal-title" id="editMessageModalLabel">Edit Message</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <label for="edit-message-content" class="form-label">Edit Message</label>
            <div class="input-group mb-3">
              <input type="hidden" id="message-id" />
              <span class="input-group-text" id="basic-addon3">Content</span>
              <input type="text" class="form-control modal-input" id="edit-message-content" aria-describedby="basic-addon3"
                maxlength="100">
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary modal-close-button" data-bs-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary" id="edit-message-button">Edit Message</button>
          </div>
        </div>
      </div>
    </div>
    <!-- Message Edit Modal -->

    <!-- Search Messages Modal -->
    <div class="modal fade" id="searchMessageModal" data-bs-backdrop="static" tabindex="-1"
      aria-labelledby="searchMessageModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header bg-dark text-white">
            <h5 class="modal-title" id="searchMessageModalLabel">Search Messages</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="input-group mb-3">
              <div class="input-group input-group-sm mb-3">
                <span class="input-group-text" id="inputGroup-sizing-sm">From</span>
                <input type="text" class="form-control" id="search-from" aria-label="Sizing example input" aria-describedby="inputGroup-sizing-sm">
                <span class="input-group-text" id="inputGroup-sizing-sm">To</span>
                <input type="text" class="form-control" id="search-to" aria-label="Sizing example input" aria-describedby="inputGroup-sizing-sm">
              </div>
              <select class="form-select form-select-sm mb-3" id="search-target" aria-label=".form-select-lg example">
                <option selected>전체 검색</option>
                <option value="1">내가 작성한 메시지</option>
                <option value="2">나를 제외한 메시지</option>
              </select>
              <div class="input-group input-group-sm mb-3">
                <span class="input-group-text" id="inputGroup-sizing-sm">검색어</span>
                <input type="text" class="form-control" aria-label="Sizing example input" id="search-keyword" aria-describedby="inputGroup-sizing-sm">
              </div>
            </div>
            <div class="row" id="result-div" class="p-5"></div>
            <ul class="list-group" id="result-ul"></ul>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary modal-close-button" data-bs-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary" id="search-message-button">Search Messages</button>
          </div>
        </div>
      </div>
    </div>
    <!-- Search Messages Modal -->
  </div>
</body>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
<!-- Latest compiled and minified JavaScript -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"
  integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe" crossorigin="anonymous"></script>
<!--Socket IO-->
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.slim.js"></script>
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.js"></script>

<script>
  $(function () {
    const $channelList = $(".channel-list")
    const $messageList = $channelList.find(".message-list")
    const $channelListModal = $("#channelListModal")
    const $editChannelModal = $("#editChannelModal")
    const $createChannelModal = $("#createChannelModal")
    const $editMessageModal = $("#editMessageModal")
    const $searchMessageModal = $("#searchMessageModal")
    const $dropdownMemberList = $channelList.find(".dropdown-member-list")
    let accessToken = window.localStorage.getItem("access-token")
    let refreshToken = window.localStorage.getItem("refresh-token")
    const tokenObj = parseJwt(accessToken)
    const host = "34.125.167.204:31060" // cloud
    // const host = "localhost:8080" // local
    const msgDiv = document.getElementById("message-list")

    /*
      Socket
    */
    // socket 연결
    const socket = io(`ws://${host}`, {
      transports: ['websocket']
    });

    // socket message emit
    function sendSocketMessage(msg) {
      socket.emit("send.message", msg)
    }

    // Socket message Listener
    socket.on('send.message', (msg) => {
      msg.isEdited = false
      $messageList.append(messageMaker(msg, true))
      msgDiv.scrollTop = msgDiv.scrollHeight
    });

    // Socket 메시지 수정
    socket.on("edit.message", (msg) => {
      editMessage(msg)
    })

    // Socket 메시지 삭제
    socket.on("delete.message", (msg) => {
      deleteMessage(msg.messageId)
    })

    // Socket 채널 수정
    socket.on("edit.channel", (msg) => {
      editChannel(msg)
    })

    // Socket 채널 삭제
    socket.on("delete.channel", (msg) => {
      deleteChannel(msg)
    })

    // Socket join channel emit
    function joinSocketRoom(channel) {
      socket.emit("join.channel", channel, () => {})
    }

    // Socket message edit
    function editSocketMessage(msg) {
      const message = JSON.parse(msg)
      editMessage(message)
      socket.emit("edit.message", msg, (result) => {})
    }

    // Socket message delete
    function deleteSocketMessage(msg) {
      const message = JSON.parse(msg)
      deleteMessage(message.messageId)
      socket.emit("delete.message", msg, (result) => {})
    }

    // Socket channel edit
    function editSocketChannel(info) {
      socket.emit("edit.channel", info, (result) => {})
    }

    // Socket channel delete
    function deleteSocketChannel(channelId) {
      socket.emit("delete.channel", channelId, (result) => { console.log(result) })
    }

    // 메시지 수정
    function editMessage(msg) {
      $messageList.find("#"+msg.messageId+" .message-content b").text(msg.content)
      if($messageList.find("#"+msg.messageId+" .message-is-edited").val() == "false") {
        $messageList.find("#"+msg.messageId+" .message-email").append(" (Edited)")
        $messageList.find("#"+msg.messageId+" .message-is-edited").val("true")
      }
    }

    // 메시지 삭제
    function deleteMessage(messageId) {
      $messageList.find("#"+messageId).remove()
    }

    // 채널 수정
    function editChannel(msg) {
      $channelList.find("#channel-info-"+msg.channelId).text(msg.content)
      if($channelList.find(".channel-info-name input").val() == String(msg.channelId)) {
        $channelList.find(".channel-info-name h4").text(msg.content)
      }
    }

    // 채널 삭제
    function deleteChannel(msg) {
      console.log(msg);
      $channelList.find("#channel-info-"+msg.channelId).closest("li").remove()
      if($channelList.find(".channel-info-name input").val() == String(msg.channelId)) {
        alert("채널이 삭제되었습니다.")
        window.location.replace("./channelList.html")
      }
    }

    /*
      JWT 로직
    */
    // token claims 만료 시간 확인
    function checkTokenValid() {
      if (new Date(tokenObj.exp) < new Date()) {
        window.localStorage.removeItem("access-token")
        window.localStorage.removeItem("refresh-token")
        alert("토큰이 만료되었습니다.\n로그인 페이지로 이동합니다.")
        window.location.replace("./login.html")
      }
    }

    // token claims parser
    function parseJwt(token) {
      if (token == undefined) {
        alert("토큰을 확인할 수 없습니다.\n로그인 페이지로 이동합니다.")
        window.location.replace("./login.html")
      }
      var base64Url = token.split('.')[1];
      var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
      var jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function (c) {
        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
      }).join(''));

      return JSON.parse(jsonPayload);
    }

    // 로그아웃
    $channelList.on("click", "#logout-button", () => {
      if (confirm("로그아웃 하시겠습니까?")) {
        $.ajax({
          url: `http://${host}/api/v1/logout`,
          method: "GET",
          dataType: "json",
          headers: { "authorization": window.localStorage.getItem("access-token"), "refreshToken": window.localStorage.getItem("refresh-token") },
        })
          .done((json) => {
            window.localStorage.removeItem("access-token")
            window.localStorage.removeItem("refresh-token")
            window.location.replace("./login.html")
          })
          .fail((xhr) => {
            if (xhr.responseJSON.code == 401) {
              window.localStorage.removeItem("access-token")
              window.localStorage.removeItem("refresh-token")
              alert("토큰이 만료되었습니다.\n로그인 페이지로 이동합니다.")
              window.location.replace("./login.html")
            }
            console.log("xhr", xhr.responseJSON)
            alert(xhr.responseJSON.message)
            checkTokenValid()
          })
      }
    })

    // 채널 접속
    $channelList.on("click", ".channel-info", (e) => {
      e.preventDefault()
      const $this = $(e.currentTarget)
      const prevChannelId = $channelList.find("#channel-id").val()
      const channelId = $this.data("channel_id")
      const channelName = $.trim($this.text())
        $(".channel-list-ul li a").removeClass("active")
        $this.addClass("active")
        $channelList.find("#chat-input").prop("disabled", false)
        getChannelInfo(channelId)
        const channel = {
          channelId: String(channelId),
          prevChannelId: prevChannelId == undefined ? "" : String(prevChannelId),
        }
        // socket room 연결
        joinSocketRoom(JSON.stringify(channel))
    })

    // 채널 정보 조회
    $channelListModal.on("click", ".channel-info", (e) => {
      e.preventDefault()
      const $this = $(e.currentTarget)
      const channelId = $this.data("channel_id")
      const channelName = $.trim($this.text())
      if (confirm(`[ ${channelName} ] 에 접속하시겠습니까?`)) {
        $.ajax({
          url: `http://${host}/api/v1/channels.join`,
          data: JSON.stringify({ channelId: channelId }),
          method: "POST",
          dataType: "json",
          headers: { "authorization": window.localStorage.getItem("access-token"), "refreshToken": window.localStorage.getItem("refresh-token") },
        })
          .done((json) => {
            alert("참가되었습니다.")
            renewToken(json.tokenResponse)
            window.location.replace("./channelList.html")
          })
          .fail((xhr) => {
            if (xhr.responseJSON.code == 401) {
              window.localStorage.removeItem("access-token")
              window.localStorage.removeItem("refresh-token")
              alert("토큰이 만료되었습니다.\n로그인 페이지로 이동합니다.")
              window.location.replace("./login.html")
            }
            console.log("xhr", xhr.responseJSON)
            alert(xhr.responseJSON.message)
            checkTokenValid()
          })
      }
    })

    // 채널 리스트 조회
    function getChannelList(isJoined, target) {
      $.ajax({
        url: `http://${host}/api/v1/channels`,
        data: { isJoined: isJoined },
        method: "GET",
        dataType: "json",
        headers: { "authorization": window.localStorage.getItem("access-token"), "refreshToken": window.localStorage.getItem("refresh-token") },
      })
        .done((json) => {
          renewToken(json.tokenResponse)
          setChannelList(json.channel, target)
        })
        .fail((xhr) => {
            console.log(xhr)
            if (xhr.responseJSON.code == 401) {
              window.localStorage.removeItem("access-token")
              window.localStorage.removeItem("refresh-token")
              alert("토큰이 만료되었습니다.\n로그인 페이지로 이동합니다.")
              window.location.replace("./login.html")
            }
            console.log("xhr", xhr.responseJSON)
            alert(xhr.responseJSON.message)
            checkTokenValid()
        })
    }

    // 채널 리스트 세팅
    function setChannelList(channels, target) {
      let list = ""
      if (channels.length == 0) {
        list += `<li>
            <div class="nav-link text-break text-white">
              참여중인 채널이 없습니다.
            </div>
          </li>`
      } else {
        channels.map((arr) => {
          list += `<li>
            <a class="nav-link text-break text-white text-lg-start channel-info" id="channel-info-${arr.channelId}" data-channel_id=${arr.channelId}>
              ${arr.channelName}
            </a>
          </li>`
        })
      }
      $(target).empty()
      $(target).append(list)
    }

    // 채널 정보 불러오기
    function getChannelInfo(channelId) {
      $.ajax({
        url: `http://${host}/api/v1/channels/${channelId}`,
        data: { channel_id: channelId },
        method: "GET",
        dataType: "json",
        headers: { "authorization": window.localStorage.getItem("access-token"), "refreshToken": window.localStorage.getItem("refresh-token") },
      })
        .done((json) => {
          renewToken(json.tokenResponse)
          $messageList.empty()
          $channelList.find(".channel-info-name h4").text(json.channel.channelName)
          $channelList.find(".channel-info-name input[id='channel-id']").val(json.channel.channelId)
          $channelList.find(".channel-info-name input[id='offset']").val("0")
          if (json.channel.createdBy == tokenObj.email) {
            $channelList.find(".channel-info-name button").css("display", "block")
          } else {
            $channelList.find(".channel-info-name button").css("display", "none")
          }
          setMessages(json.message)
          setMembers(json.member)
          msgDiv.scrollTop = msgDiv.scrollHeight
        })
        .fail((xhr) => {
            if (xhr.responseJSON.code == 401) {
              window.localStorage.removeItem("access-token")
              window.localStorage.removeItem("refresh-token")
              alert("토큰이 만료되었습니다.\n로그인 페이지로 이동합니다.")
              window.location.replace("./login.html")
            }
            console.log("xhr", xhr.responseJSON)
            alert(xhr.responseJSON.message)
            checkTokenValid()
        })
    }

    // 메시지 최상단 스크롤 이벤트
    $("#message-list").on("scroll", (e) => {
      const channelId = $channelList.find("#channel-id").val()
      const offset = $channelList.find("#offset").val()
      if($("#message-list").scrollTop() == 0) {
        messageLoader(channelId, offset)
        $channelList.find("#offset").val(parseInt(offset) + 1)
      }
    })

    // 메시지 로더
    function messageLoader(channelId, offset) {
      $.ajax({
        url: `http://${host}/api/v1/messages/${channelId}`,
        data: { offset: offset },
        method: "GET",
        dataType: "json",
        headers: { "authorization": window.localStorage.getItem("access-token"), "refreshToken": window.localStorage.getItem("refresh-token") },
      })
        .done((json) => {
          setMessages(json.message)
        })
        .fail((xhr) => {
          if (xhr.responseJSON.code == 401) {
            window.localStorage.removeItem("access-token")
            window.localStorage.removeItem("refresh-token")
            alert("토큰이 만료되었습니다.\n로그인 페이지로 이동합니다.")
            window.location.replace("./login.html")
          }
          console.log("xhr", xhr.responseJSON)
          alert(xhr.responseJSON.message)
          checkTokenValid()
        })
    }

    // 메시지 리스트 만들기
    function setMessages(messages) {
      if (messages.length == 0) {
        return;
      } else {
        messages.map((arr) => {
          arr.isEdited = (arr.createdAt != arr.updatedAt ? true : false)
          $messageList.prepend(messageMaker(arr, true))
        })
      }
      msgDiv.scrollTop = msgDiv.scrollHeight
    }

    function messageMaker(message, isGolang) {
      return `<div class="message-div mb-2 p-2 border border-secondary border-2 rounded" id="${message.messageId}" data-message_id="${message.messageId}">
        <div class="row">
          <input type="hidden" class="message-is-edited" value="${message.isEdited == true ? "true" : "false"}"/>
          <p class="message-email col-8">${message.email}${message.isEdited ? " (Edited)" : ""} </p>
          ${message.email == tokenObj.email ? 
            `<a class="message-edit-button btn btn-sm btn-warning col-1" data-bs-toggle="modal" data-bs-target="#editMessageModal" data-message_id=${message.messageId}>수정</a>
            <a class="message-delete-button btn btn-sm btn-danger col-1" data-message_id=${message.messageId}>삭제</a>
            ` : ""}
        </div>
        <span class="time_date message-content"> <b>${message.content}</b></br>${dateFormatter(message.createdAt, isGolang)}</span>
      </div>`
    }
    
    // 날짜 Formatter
    function dateFormatter(date, isGolang) {
      let str
      if (isGolang) {
        str = $.trim(date.split("\+")[0])
      } else {
        str = date
      }
      const newDate = new Date(str)
      const year = newDate.getFullYear()
      const month = String(newDate.getMonth()+1).padStart(2, '0')
      const day = String(newDate.getDate()).padStart(2, '0')
      const hour = String(newDate.getHours()).padStart(2, '0')
      const min = String(newDate.getMinutes()).padStart(2, '0')
      const second = String(newDate.getSeconds()).padStart(2, '0')
      
      return year + "-" + month + "-" + day + " " + hour + ":" + min + ":" + second
    }
    
    // 채팅방 멤버 넣기
    function setMembers(members) {
      let list = ""
      members.map((arr) => {
        list += `<li><a class="dropdown-item">${arr.email}</a></li>`
      })
      $dropdownMemberList.empty()
      $dropdownMemberList.append(list)
    }

    // 채널 검색
    $channelList.find("#search-channel").on('click', function () {
      getChannelList(false, ".joinable-channel-list")
    })

    // 메시지 생성
    $channelList.on("click", "#chat-button", (e) => {
      e.preventDefault()
      const content = $.trim($channelList.find("#chat-input").val())
      const channelId = $channelList.find("#channel-id").val()
      const messageId = uuidv4()
      console.log(messageId)
      const date = new Date()
      console.log(date);
      if (content.length == 0) {
        return
      }
      // socket 전송
      const message = {
        messageId: messageId,
        email: tokenObj.email,
        content: content,
        channelId: String(channelId),
        createdAt: date,
        updatedAt: date,
      }
      sendSocketMessage(JSON.stringify(message))
      message.isEdited = false
      $messageList.append(messageMaker(message, false))
      msgDiv.scrollTop = msgDiv.scrollHeight
      $channelList.find("#chat-input").val("")
      // rest api 전송
      $.ajax({
        url: `http://${host}/api/v1/messages`,
        data: JSON.stringify({
          messageId: messageId,
          channelId: channelId,
          content: content,
          createdAt: date,
          updatedAt: date,
        }),
        method: "POST",
        dataType: "json",
        headers: { 
          "authorization": window.localStorage.getItem("access-token"), 
          "refreshToken": window.localStorage.getItem("refresh-token") 
        },
      })
        .done((json) => {
          renewToken(json.tokenResponse)
        })
        .fail((xhr) => {
            if (xhr.responseJSON.code == 401) {
              window.localStorage.removeItem("access-token")
              window.localStorage.removeItem("refresh-token")
              alert("토큰이 만료되었습니다.\n로그인 페이지로 이동합니다.")
              window.location.replace("./login.html")
            }
            console.log("xhr", xhr.responseJSON)
            alert(xhr.responseJSON.message)
            checkTokenValid()
        })
    })

    // 메세지 생성 엔터 
    $channelList.on("keyup", "#chat-input", (e) => {
      if (e.keyCode == 13) {
        $channelList.find("#chat-button").trigger("click")
      }
    })

    // 채널 수정
    $editChannelModal.on("click", "#edit-channel-button", (e) => {
      const channelName = $.trim($editChannelModal.find("#edit-channel-name").val())
      const channelId = $channelList.find("#channel-id").val()
      if (channelName.length == 0) {
        alert("채널명을 입력해주세요")
        return
      }
      $editChannelModal.find("#edit-channel-name").val("")
      if (confirm(`채널명을 [${channelName}] 으로 변경하시겠습니까?`)) {
        editSocketChannel(JSON.stringify({
          channelId : channelId,
          content: channelName,
        }))
        $.ajax({
          url: `http://${host}/api/v1/channels/${channelId}`,
          data: JSON.stringify({
            channelName: channelName,
          }),
          method: "PATCH",
          dataType: "json",
          headers: { "authorization": window.localStorage.getItem("access-token"), "refreshToken": window.localStorage.getItem("refresh-token") },
        })
          .done((json) => {
            renewToken(json.tokenResponse)
            getChannelList(true, ".channel-list-ul")
            $channelList.find(".channel-info-name h4").text(channelName)
            $editChannelModal.find(".modal-close-button").trigger("click")
          })
          .fail((xhr) => {
            if (xhr.responseJSON.code == 401) {
              window.localStorage.removeItem("access-token")
              window.localStorage.removeItem("refresh-token")
              alert("토큰이 만료되었습니다.\n로그인 페이지로 이동합니다.")
              window.location.replace("./login.html")
            }
            console.log("xhr", xhr.responseJSON)
            alert(xhr.responseJSON.message)
            checkTokenValid()
          })
      }
    })

    // 채널 수정 엔터 이벤트
    $editChannelModal.on("keyup", "#edit-channel-name", (e) => {
      e.preventDefault()
      if(e.keyCode == 13) {
        $editChannelModal.find("#edit-channel-button").trigger("click")
      }
    })

    // 채널 삭제 
    $channelList.on("click", "#delete-channel", (e) => {
      const channelId = $channelList.find("#channel-id").val()
      if (confirm("채널을 삭제하시겠습니까?")) {
        deleteSocketChannel(channelId)
        $.ajax({
          url: `http://${host}/api/v1/channels/${channelId}`,
          data: {},
          method: "DELETE",
          dataType: "json",
          headers: { "authorization": window.localStorage.getItem("access-token"), "refreshToken": window.localStorage.getItem("refresh-token") },
        })
          .done((json) => {
            renewToken(json.tokenResponse)
            window.location.replace("./channelList.html")
          })
          .fail((xhr) => {
            if (xhr.responseJSON.code == 401) {
              window.localStorage.removeItem("access-token")
              window.localStorage.removeItem("refresh-token")
              alert("토큰이 만료되었습니다.\n로그인 페이지로 이동합니다.")
              window.location.replace("./login.html")
            }
            console.log("xhr", xhr.responseJSON)
            alert(xhr.responseJSON.message)
            checkTokenValid()
          })
      }
    })

    // 채널 생성
    $createChannelModal.on("click", "#create-channel-button", (e) => {
      e.preventDefault()
      const channelName = $.trim($createChannelModal.find("#new-channel-name").val())
      if (channelName.length == 0) {
        alert("채널명을 입력해주세요")
        return
      }
      if (confirm(`[${channelName}] 채널을 만드시겠습니까?`)) {
        $.ajax({
          url: `http://${host}/api/v1/channels`,
          data: JSON.stringify({
            channelName: channelName,
          }),
          method: "POST",
          dataType: "json",
          headers: { "authorization": window.localStorage.getItem("access-token"), "refreshToken": window.localStorage.getItem("refresh-token") },
        })
          .done((json) => {
            renewToken(json.tokenResponse)
            window.location.replace("./channelList.html")
          })
          .fail((xhr) => {
            if (xhr.responseJSON.code == 401) {
              window.localStorage.removeItem("access-token")
              window.localStorage.removeItem("refresh-token")
              alert("토큰이 만료되었습니다.\n로그인 페이지로 이동합니다.")
              window.location.replace("./login.html")
            }
            console.log("xhr", xhr.responseJSON)
            alert(xhr.responseJSON.message)
            checkTokenValid()
          })
      }
    })

    // 메시지 수정 버튼 클릭 이벤트
    $channelList.on("click", ".message-edit-button", (e) => {
      e.preventDefault()
      const $this = $(e.currentTarget)
      const messageId = $this.data("message_id")
      $editMessageModal.find("#message-id").val(messageId)
    })

    // 메세지 수정 모달 > 메세지 수정 (소켓, api)
    $editMessageModal.on("click", "#edit-message-button", (e) => {
      e.preventDefault()
      const $this = $(e.currentTarget)
      const channelId = $channelList.find("#channel-id").val()
      const messageId = $editMessageModal.find("#message-id").val()
      const content = $editMessageModal.find("#edit-message-content").val()
      if ($.trim(content).length == 0) {
        return
      }
      $editMessageModal.find("#edit-message-content").val("")
      const date = new Date()
      const message = {
        channelId: channelId,
        messageId: messageId,
        email: tokenObj.email,
        content: content,
        updatedAt: date,
      }
      editSocketMessage(JSON.stringify(message))
      $.ajax({
        url: `http://${host}/api/v1/messages/${messageId}`,
        data: JSON.stringify({
          content: content,
          updatedAt: date,
        }),
        method: "PATCH",
        dataType: "json",
        headers: { "authorization": window.localStorage.getItem("access-token"), "refreshToken": window.localStorage.getItem("refresh-token") },
      })
        .done((json) => {
          renewToken(json.tokenResponse)
          $editMessageModal.find(".modal-close-button").trigger("click")
        })
        .fail((xhr) => {
            if (xhr.responseJSON.code == 401) {
              window.localStorage.removeItem("access-token")
              window.localStorage.removeItem("refresh-token")
              alert("토큰이 만료되었습니다.\n로그인 페이지로 이동합니다.")
              window.location.replace("./login.html")
            }
            console.log("xhr", xhr.responseJSON)
            alert(xhr.responseJSON.message)
            checkTokenValid()
        })
    })

    // 채널 생성 인풋박스 엔터
    $createChannelModal.on("keyup", "#new-channel-name", (e) => {
      e.preventDefault()
      const $this = $(e.currentTarget)
      if(e.keyCode == 13) {
        $createChannelModal.find("#create-channel-button").trigger("click")
      }
    })

    // 메시지 수정 인풋박스 엔터
    $editMessageModal.on("keyup", "#edit-message-content", (e) => {
      e.preventDefault()
      const $this = $(e.currentTarget)
      if(e.keyCode == 13) {
        $editMessageModal.find("#edit-message-button").trigger("click")
      }
    })

    // 메세지 삭제 (소켓, api)
    $channelList.on("click", ".message-delete-button", (e) => {
      e.preventDefault()
      const $this = $(e.currentTarget)
      const channelId = String($channelList.find("#channel-id").val())
      const messageId = String($this.data("message_id"))
      const message = {
        channelId: channelId,
        messageId: messageId,
        email: tokenObj.email,
      }
      if (confirm("메시지를 삭제하시겠습니까?")) {
        deleteSocketMessage(JSON.stringify(message))
        $.ajax({
          url: `http://${host}/api/v1/messages/${messageId}`,
          method: "DELETE",
          headers: { "authorization": window.localStorage.getItem("access-token"), "refreshToken": window.localStorage.getItem("refresh-token") },
        })
          .done((json) => {
            renewToken(json.tokenResponse)
            console.log("[api result] message: " + messageId + " 삭제 완료")
          })
          .fail((xhr) => {
            if (xhr.responseJSON.code == 401) {
              window.localStorage.removeItem("access-token")
              window.localStorage.removeItem("refresh-token")
              alert("토큰이 만료되었습니다.\n로그인 페이지로 이동합니다.")
              window.location.replace("./login.html")
            }
            console.log("xhr", xhr.responseJSON)
            alert(xhr.responseJSON.message)
            checkTokenValid()
          })
      }
    })

    // 검색 모달 엔터 이벤트
    $searchMessageModal.on("keyup", "#search-keyword", (e) => {
      e.preventDefault()
      if(e.keyCode == 13) {
        $searchMessageModal.find("#search-message-button").trigger("click")
      }
    })

    // 검색 모달 검색 이벤트
    $searchMessageModal.on("click", "#search-message-button", (e) => {
      e.preventDefault()
      let keyword = $searchMessageModal.find("#search-keyword").val()
      let from = $searchMessageModal.find("#search-from").val()
      let to = $searchMessageModal.find("#search-to").val()
      if($.trim(keyword) == "") {
        return
      }
      if (from == "") {
        from = "2000-01-01"
      }
      if (to == "") {
        const date = new Date()
        to = date.getFullYear() + "-" + String(date.getMonth()+1).padStart(2, '0') + "-" + String(date.getDate()).padStart(2, '0')
      }
      $.ajax({
        url: `http://${host}/api/v1/search`,
        method: "GET",
        data: { keyword: keyword, from: from, to: to },
        headers: { "authorization": window.localStorage.getItem("access-token"), "refreshToken": window.localStorage.getItem("refresh-token") },
      })
        .done((json) => {
          renewToken(json.tokenResponse)
          // 메시지 콘솔에 찍기 추후 변경하자
          consoleLogger(json.message)
        })
        .fail((xhr) => {
          if (xhr.responseJSON.code == 401) {
            window.localStorage.removeItem("access-token")
            window.localStorage.removeItem("refresh-token")
            alert("토큰이 만료되었습니다.\n로그인 페이지로 이동합니다.")
            window.location.replace("./login.html")
          }
          console.log("xhr", xhr.responseJSON)
          alert(xhr.responseJSON.message)
          checkTokenValid()
        })
    })

    function consoleLogger(messages) {
      let html = ""
            //   <li>bht9011@naver.com 안녕하세요</li>
            //   <li>bht9011@naver.com 안녕하세요</li>
            //   <li>bht9011@naver.com 안녕하세요</li>
            //   <li>bht9011@naver.com 안녕하세요</li>
      $searchMessageModal.find("#result-div").text(`검색결과 ${messages.length}건`)
      messages.map((arr, _) => {
        html += `<li class="list-group-item">`
        html += `<div>채널id : ${arr.channelId}</div>
                <div>email : ${arr.email}</div>
                <div>content : ${arr.content}</div>
                <div>작성일 : ${arr.createdAt}</div>
              `
        html += "</li>"
      })
      $searchMessageModal.find("#result-ul").empty()
      $searchMessageModal.find("#result-ul").append(html)
      
    }

    // uuid 생성기
    function uuidv4() {
      return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
        (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
      );
    }

    function renewToken(token) {
      window.localStorage.setItem("access-token", token.accessToken)
      window.localStorage.setItem("refresh-token", token.refreshToken)
    }

    // 모달 인풋박스 포싱
    document.querySelector("#channelListModal").addEventListener('shown.bs.modal', (e) => {
      const $this = $(e.currentTarget)
      $this.find(".modal-input").focus()
    })
    document.querySelector("#editChannelModal").addEventListener('shown.bs.modal', (e) => {
      const $this = $(e.currentTarget)
      $this.find(".modal-input").focus()
    })
    document.querySelector("#createChannelModal").addEventListener('shown.bs.modal', (e) => {
      const $this = $(e.currentTarget)
      $this.find(".modal-input").focus()
    })
    document.querySelector("#editMessageModal").addEventListener('shown.bs.modal', (e) => {
      const $this = $(e.currentTarget)
      $this.find(".modal-input").focus()
    })

    // 검색 모달 date picker 초기화
    var dateFormat = "yy-mm-dd",
      from = $( "#search-from" )
        .datepicker({
          dateFormat: 'yy-mm-dd',
          language: 'kr',
          defaultDate: "+1w",
          changeMonth: true,
          numberOfMonths: 1,
          beforeShow: function() {
            setTimeout(function(){
              $('.ui-datepicker').css('z-index', 99999999999999);
            }, 0);
          }
        })
        .on( "change", function() {
          to.datepicker( "option", "minDate", getDate( this ) );
        }),
      to = $( "#search-to" ).datepicker({
        dateFormat: 'yy-mm-dd',
        language: 'kr',
        defaultDate: "+1w",
        changeMonth: true,
        numberOfMonths: 1,
        beforeShow: function() {
          setTimeout(function(){
            $('.ui-datepicker').css('z-index', 99999999999999);
          }, 0);
        }
      })
      .on( "change", function() {
        from.datepicker( "option", "maxDate", getDate( this ) );
      });
 
    function getDate( element ) {
      var date;
      try {
        date = $.datepicker.parseDate( dateFormat, element.value );
      } catch( error ) {
        date = null;
      }
      return date;
    }


    
    

    // 유저 아이디 입력
    $channelList.find("#username").text(tokenObj.name == undefined ? "unknown" : tokenObj.name)

    getChannelList(true, ".channel-list-ul")
  })
</script>

</html>